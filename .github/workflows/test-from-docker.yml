name: Execute tests inside Docker container
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  workflow_dispatch:

jobs:
    container-test-job:
        permissions:
            contents: write
            pull-requests: write
        runs-on: ubuntu-latest
        name: execute a test from a image
        steps:        
            - name: set up a docker environement
              uses: docker/setup-buildx-action@v3   

            - name: Login to Docker hub
              uses: docker/login-action@v3
              with:
                username: ${{ vars.DOCKER_USER_NAME }}
                password: ${{ secrets.DOCKER_PASSWORD }}

            - name: pull and run the test from image
              run: |
                docker pull ${{ vars.DOCKER_USER_NAME }}/playwright-ui-typescript:latest
                docker run  -v ./playwright-report:/app/playwright-report \
                      thanandock/playwright-ui-typescript:latest \
                      -c "npx playwright test"


            - name: Add the test summary status back to PR comment
              uses: mshick/add-pr-comment@v2
              if: (contains(fromJSON('["pull_request"]'), github.event_name))
              env:
                content:  $(cat ./playwright-report/result.txt) 
              with:
                message-path: |
                        ./playwright-report/result.txt
                message-failure: |
                        Workflow failed
    
    publish-reports:
        if: ${{ contains(github.ref,'main') &&  (contains(fromJSON('[ "push"]'), github.event_name)) }}
        needs: [ container-test-job ]
        runs-on: ubuntu-latest
        permissions: 
            pages: write
            id-token: write
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}

        steps:
        - name: Setup Pages
          uses: actions/configure-pages@v3

        - name: Upload Artifact for pages
          uses: actions/upload-pages-artifact@v1
          with:
                path: "./playwright-report"

        - name: Deploy to GitHub Pages
          id: deployment
          uses: actions/deploy-pages@v2
            
       
        

